# CS12 HACX (CTRL-C)

> **Disclaimer**: This README is generated by AI and may contain slight inaccuracies. Please verify technical details and refer to the source code for definitive information.

A comprehensive Python application for annotating and managing 3D point clouds with interactive tagging, photo attachments, and floor plan generation capabilities. This solution addresses the challenges of crime scene documentation by providing automated geospatial tagging, real-time evidence placement, and automatic floor plan generation with dimensional measurements.

## Overview

Point Cloud Annotation Studio is a desktop application built with Open3D that enables users to:
- Visualize 3D point clouds interactively
- Tag specific points in 3D space with metadata
- Attach photos to tags
- Export annotated point clouds
- Generate 2D floor plans from point cloud data

## Problem Statement & Solution

### The Challenge

Crime scene documentation is a slow and labor-intensive process. As scene size increases, so does the time and effort required. Current methods face several critical gaps:

**Existing Gaps in Current Solutions:**
- **Manual and laborious**: Traditional documentation requires extensive manual work
- **Manual spatial tagging**: Post-processing of 3D scanned models requires manual marker placement (e.g., Germonizer R2S Mosaic, Azure Digital Twin)
- **Time-consuming post-processing**: Significant lag time before digital twins can be used
- **Delayed availability**: Digital representations are not immediately available for analysis

### How This Solution Addresses the Problem

This application provides a comprehensive solution that directly addresses these gaps:

1. **Automated Geospatial Tagging**: 
   - Real-time interactive tagging directly in the 3D point cloud
   - No manual post-processing required - tags are placed immediately during scene review
   - Precise coordinate selection using depth buffer unprojection for accuracy within 1-3 cm

2. **Immediate Digital Representation**:
   - Tags are instantly linked to the 3D representation
   - No lag time - work can begin immediately after point cloud loading
   - Real-time visualization of evidence markers in their exact spatial positions

3. **Automated Floor Plan Generation**:
   - Automatic 2D floor plan generation to scale
   - Evidence markers automatically projected onto floor plans
   - Automatic dimensional measurements for floor and wall areas
   - Multiple export formats (PNG, PLY) for integration with other tools

4. **Enhanced Evidence Documentation**:
   - Digital tag movement capability - adjust positions as needed without re-scanning
   - Multi-media support - attach photos and reports directly to evidence tags
   - Automated evidence processing with AI-powered object detection (Google Gemini API)
   - Persistent storage in JSON format for easy backup and sharing

5. **Workflow Efficiency**:
   - Single integrated tool eliminates need for multiple software packages
   - Streamlined workflow from point cloud to annotated floor plan
   - Export capabilities for integration with existing crime scene documentation systems

### Accuracy & Deliverables

- **Spatial Accuracy**: Tags are placed with precision within 1-3 cm using depth buffer-based 3D point picking
- **Automatic Measurements**: Floor plans include automatic dimensional calculations
- **Geospatial Linking**: Tags are automatically linked between 3D representation and 2D floor plans
- **Digital Tag Adjustment**: Tags can be digitally shifted in the GUI without requiring re-scanning
- **Multi-Data Input**: Support for photos, reports, and metadata attached to evidence tags

### Approach & Logic

**Geospatial Tagging Approach:**
- **Object Identification Annotation**: Uses interactive 3D point picking to identify and tag evidence locations
- **Sensor-based Annotation**: Leverages depth buffer unprojection from the visualization camera to convert 2D screen coordinates to precise 3D world coordinates
- **Real-time Processing**: Tags are processed and stored immediately, eliminating post-processing delays

**Floor Plan Generation Logic:**
- **PCA-based Alignment**: Uses Principal Component Analysis to automatically align the point cloud and remove tilt
- **Floor Extraction**: Identifies floor points using Z-value thresholding on the lowest points
- **Wall Extraction**: Extracts vertical sections by analyzing point density in vertical slices
- **Automatic Projection**: Projects 3D tags onto 2D floor plans using coordinate transformation
- **Measurement Calculation**: Computes dimensions using geometric analysis of extracted floor and wall boundaries

**Technology Stack:**
- **Open3D**: Core 3D point cloud processing and visualization
- **Open-source Tools**: Built entirely with open-source libraries (Open3D, NumPy, Matplotlib, Shapely)
- **AI Integration**: Optional Google Gemini API for automated object detection in evidence photos

### Assumptions & Limitations

**Assumptions:**
- Point cloud data is provided in PLY format with standard coordinate system
- Point cloud contains sufficient floor points for floor plan generation
- User has basic familiarity with 3D visualization interfaces
- For evidence processing, Google Gemini API key is available (optional feature)

**Limitations:**
- Accuracy depends on point cloud density and quality - sparse point clouds may have reduced precision
- Floor plan generation assumes relatively flat floors and vertical walls
- Large point clouds (>10M points) may experience performance degradation
- Evidence processing requires internet connection for API calls
- GUI is currently desktop-only (not web-based)
- Floor plan measurements are approximate and should be verified for critical applications

## Features

### ğŸ·ï¸ Interactive Tagging
- **3D Point Selection**: Use Shift+Click to pick precise 3D coordinates in the point cloud
- **Tag Management**: Create, edit, and delete tags with title and description
- **Tag Movement**: Move existing tags to new locations using Shift+M move mode
- **Visual Markers**: Color-coded spherical markers indicate tag locations
- **Tag Highlighting**: Selected tags are highlighted with larger, brighter markers
- **Persistent Storage**: Tags are saved to JSON format for easy backup and sharing

### ğŸ“· Photo Management
- **Multi-Photo Support**: Attach multiple photos to each tag
- **Organized Storage**: Photos are automatically organized by tag ID
- **File Management**: Easy upload and deletion of tag-associated photos

### ğŸ“¦ Export Functionality
- **Annotated Point Clouds**: Export point clouds with embedded tag markers as PLY files
- **Metadata Export**: Generate JSON metadata files containing tag information
- **Timestamped Exports**: Automatic timestamping for version control

### ğŸ—ï¸ Floor Plan Generation
- **2D Projection**: Generate top-down floor plans from point cloud data to scale
- **Auto-Alignment**: PCA-based alignment to remove tilt and normalize orientation
- **Wall Extraction**: Extract individual wall slices from vertical point cloud sections
- **Automatic Measurements**: Calculate dimensions and areas for floor and walls automatically
- **Evidence Marker Projection**: Automatically project geospatial tags onto floor plans showing evidence in exact positions
- **Multiple Export Formats**: Export floor plans as PNG images and PLY point clouds

## Installation

### Prerequisites

- Python 3.7 or higher
- Open3D
- NumPy
- Matplotlib
- Shapely
- scikit-image
- Google Gemini API key (for evidence processing)

### Install Dependencies

```bash
pip install open3d numpy matplotlib shapely scikit-image google-genai pillow
```

For GUI functionality on Linux, you may also need:
```bash
sudo apt-get install python3-tk
```

For evidence processing with Gemini API:
```bash
pip install google-genai pillow
```

## Usage

### Running the Application

1. **Prepare your point cloud file**: Place your PLY file in the project root directory (default: `CS12-MockWarehouse.ply`)

2. **Configure the application**: Edit `config.py` to set your point cloud file path if needed

3. **Run the main application**:
   ```bash
   python main.py
   ```

### Basic Workflow

1. **Load Point Cloud**: The application automatically loads the point cloud specified in `config.py`

2. **Tag Points**:
   - Hold **Shift** and **Click** on any point in the 3D scene
   - A temporary yellow marker appears at the selected location
   - Coordinates are automatically populated in the coordinate panel

3. **Add Tag Information**:
   - Enter a title and description in the Tag Information panel
   - Optionally upload photos using the Photos panel
   - Click **ğŸ’¾ Save Tag** to permanently save the tag

4. **Manage Tags**:
   - View all tags in the "Existing Tags" list
   - Select a tag to view its details and highlight it in the 3D scene
   - Delete tags using the **ğŸ—‘ï¸ Delete** button

5. **Move Tags** (Bonus Feature):
   - Select a tag from the "Existing Tags" list
   - Press **Shift + M** to enable move mode
   - **Shift + Click** on the new desired location
   - The tag will be moved and saved automatically
   - Press **Shift + M** again to exit move mode

6. **Export Results**:
   - Click **ğŸ“¦ Export Cloud + Tags** to create an annotated PLY file
   - The export includes both the point cloud and embedded tag markers
   - A JSON metadata file is also generated with all tag information

### Floor Plan Generator

To generate floor plans from a tagged point cloud:

1. **Run the floor plan generator**:
   ```bash
   cd floor_plan
   python floor_plan_generator.py
   ```

2. **Output files** are saved in `floor_plan/exports/`:
   - `floor_plan.png`: 2D floor plan visualization
   - `floor_points.ply`: Floor point cloud
   - `wall_slice_*.png`: Individual wall slice visualizations
   - `wall_slice_*_points.ply`: Wall slice point clouds
   - `combined_overview.png`: Combined floor and wall visualization

### Evidence Processing

To process evidence images using Google Gemini API for object detection:

1. **Set up API key**:
   ```bash
   # Option 1: Set environment variable
   export GOOGLE_API_KEY="your-api-key-here"
   
   # Option 2: Pass as argument (see below)
   ```

2. **Process all tags**:
   ```bash
   python process_evidences.py
   ```

3. **Process a specific tag**:
   ```bash
   python process_evidences.py --tag-id "tag-uuid-here"
   ```

4. **With API key argument**:
   ```bash
   python process_evidences.py --api-key "your-api-key-here"
   ```

5. **Output files** are saved in:
   - `data/evidence_detections/`:
     - `{tag_id}_detections.json`: Detailed detection data for each image
     - `{tag_id}_summary.txt`: Consolidated summary of detected objects
   - `data/post_process/{tag_id}/`:
     - `{image_name}_annotated.{ext}`: Images with colored bounding boxes drawn

The script processes all photos associated with each tag, detects objects using Gemini API, and generates:
- Bounding boxes for each detected object
- Object labels and confidence scores
- Per-image detection results
- Consolidated scene summary for each tag
- **Annotated images** with colored bounding boxes (same color for same object type)

## Project Structure

```
Point Cloud/
â”œâ”€â”€ main.py                      # Application entry point
â”œâ”€â”€ config.py                    # Configuration and constants
â”œâ”€â”€ point_cloud_viewer.py        # Simple point cloud viewer utility
â”œâ”€â”€ process_evidences.py         # Evidence image processing with Gemini API
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ point_cloud_manager.py   # Point cloud loading and operations
â”‚   â”‚   â””â”€â”€ tag_manager.py           # Tag persistence and management
â”‚   â”‚
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â””â”€â”€ tag.py                   # Tag data model
â”‚   â”‚
â”‚   â”œâ”€â”€ handlers/
â”‚   â”‚   â””â”€â”€ mouse_handler.py         # Mouse event handling for 3D picking
â”‚   â”‚
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ geometry_utils.py        # 3D geometry utilities
â”‚   â”‚   â””â”€â”€ file_manager.py          # File operations for photos
â”‚   â”‚
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ main_window.py           # Main application window
â”‚       â””â”€â”€ panels/
â”‚           â”œâ”€â”€ coordinate_panel.py  # Coordinate display/input
â”‚           â”œâ”€â”€ tag_info_panel.py    # Tag information input
â”‚           â””â”€â”€ photo_panel.py       # Photo upload/management
â”‚
â”œâ”€â”€ floor_plan/
â”‚   â”œâ”€â”€ floor_plan_generator.py      # Floor plan generation pipeline
â”‚   â””â”€â”€ exports/                     # Generated floor plans and exports
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ tags.json                    # Tag storage (auto-generated)
â”‚   â”œâ”€â”€ tag_photos/                  # Photo storage directory
â”‚   â”œâ”€â”€ evidence_detections/         # Evidence processing results (auto-generated)
â”‚   â””â”€â”€ post_process/                # Annotated images with bounding boxes (auto-generated)
â”‚
â””â”€â”€ CS12-MockWarehouse.ply          # Default point cloud file
```

## Configuration

Edit `config.py` to customize:

- **Point Cloud File**: Change `POINT_CLOUD_FILE` to load a different PLY file
- **Storage Paths**: Modify `TAGS_FILE` and `PHOTOS_DIR` for different storage locations
- **UI Settings**: Adjust window size, panel width, and colors
- **Marker Settings**: Change marker radius and point size for visualization

## Key Components

### PointCloudManager
Manages point cloud loading, visualization, and export operations. Handles PLY file I/O and tag marker embedding.

### TagManager
Provides persistent storage for tags using JSON format. Supports CRUD operations for tags.

### MouseHandler
Implements 3D point picking using depth buffer unprojection. Enables precise coordinate selection with Shift+Click.

### GeometryUtils
Utility functions for creating 3D markers, coloring point clouds, and generating random colors.

### FileManager
Handles photo file operations, including copying photos to tag-specific directories and cleanup.

### FloorPlanGenerator
Complete pipeline for:
- Coordinate normalization (starting at origin)
- PCA-based alignment
- Floor extraction from low Z-values
- Wall slice extraction from vertical sections
- Automatic measurement calculations
- Multi-format export (PNG, PLY)

## Keyboard Shortcuts

- **Shift + Click**: Pick 3D point in the scene (for new tag placement)
- **Shift + M**: Toggle move mode (to relocate existing tags)
- Standard Open3D navigation:
  - **Mouse Drag**: Rotate camera
  - **Scroll**: Zoom in/out
  - **Middle Mouse Drag**: Pan camera

### Moving Tags

To move an existing tag:
1. Select a tag from the "Existing Tags" list
2. Press **Shift + M** to enable move mode
3. **Shift + Click** on the new location in the 3D scene
4. The tag will be moved to the new coordinates
5. Press **Shift + M** again to exit move mode

## Data Format

### Tag JSON Structure
```json
{
  "id": "unique-uuid",
  "coords": [x, y, z],
  "title": "Tag Title",
  "description": "Tag Description",
  "photos": ["path/to/photo1.jpg", "path/to/photo2.jpg"],
  "color": [r, g, b]
}
```

### Export Metadata
Exported metadata JSON includes:
- Original file path
- Export timestamp
- Point count
- Number of tags
- Complete tag information

## Troubleshooting

### Point Cloud Won't Load
- Verify the PLY file path in `config.py`
- Ensure the file exists and is a valid PLY format
- Check that the file contains points (not empty)

### GUI Not Displaying
- On Linux, install `python3-tk`: `sudo apt-get install python3-tk`
- Ensure Open3D GUI backend is properly installed
- Check that display server is running (X11/Wayland)

### Floor Plan Generation Issues
- Ensure the point cloud has sufficient floor points
- Adjust `floor_threshold` if floor is not detected
- Check that Shapely and scikit-image are installed
- Verify the input PLY file path in `floor_plan_generator.py`

## License

This project is open source and available under the MIT License.

## Contributing

Contributions are welcome! Please feel free to submit pull requests or open issues for bugs and feature requests.

## Acknowledgments

- Built with [Open3D](http://www.open3d.org/)
- Uses [Shapely](https://shapely.readthedocs.io/) for geometric operations
- [Matplotlib](https://matplotlib.org/) for visualization

